---
import Layout from "../layouts/Layout.astro";
import MediaPicker from "../components/MediaPicker.astro";
---

<Layout title="Flow Editor">
    <!-- Main container hidden until loaded -->
    <div
        x-data="flowEditor"
        x-show="ready"
        class="h-[calc(100vh-100px)] flex flex-col min-h-0"
        style="display: none;"
    >
        <!-- Header -->
        <header
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6 border-b border-wa-border pb-4 shrink-0"
        >
            <div class="flex-1 min-w-0 w-full sm:w-auto">
                <div class="flex items-center gap-2 mb-1">
                    <span
                        class="text-[10px] font-sans text-wa-green bg-wa-green/10 px-2 py-0.5 rounded-lg shrink-0"
                        x-text="bot.platform || 'BOT'"></span>
                    <span
                        class="text-[10px] font-sans text-wa-text-secondary truncate"
                        x-text="bot.identifier || '...'"></span>
                </div>
                <input
                    type="text"
                    x-model="flow.name"
                    class="bg-transparent text-xl sm:text-2xl font-bold tracking-tight w-full focus:outline-none focus:border-b border-wa-green rounded-lg"
                    :placeholder="$t('flow_name')"
                />
                <input
                    type="text"
                    x-model="flow.description"
                    class="bg-transparent text-xs text-wa-text-secondary font-sans w-full focus:outline-none mt-1 rounded-lg"
                    :placeholder="$t('flow_description')"
                />
            </div>

            <div class="flex gap-2 sm:gap-4 shrink-0 w-full sm:w-auto">
                <a
                    :href="'/bots/detail?id=' + (bot.id || new URLSearchParams(window.location.search).get('botId') || '')"
                    role="button"
                    class="px-4 sm:px-6 py-2 border border-wa-border text-wa-text-secondary font-sans text-xs hover:text-white hover:bg-wa-bg-hover transition-colors flex items-center justify-center flex-1 sm:flex-initial rounded-lg"
                    x-text="$t('back')"
                >
                </a>
                <button
                    @click="save()"
                    :disabled="saving"
                    class="px-4 sm:px-6 py-2 bg-wa-green text-white font-sans text-xs hover:bg-wa-green-hover transition-colors disabled:opacity-50 flex-1 sm:flex-initial rounded-lg"
                >
                    <span x-text="saving ? $t('saving') : $t('save_flow')"
                    ></span>
                </button>
            </div>
        </header>

        <div
            class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-8 min-h-0"
        >
            <!-- LEFT PANEL: Triggers & Settings -->
            <div class="col-span-1 overflow-y-auto pr-0 lg:pr-2 max-h-[40vh] lg:max-h-none">
                <!-- Triggers -->
                <div
                    class="bg-wa-bg-panel border border-wa-border p-4 sm:p-6 mb-6 relative group rounded-xl"
                >
                    <div
                        class="text-xs text-wa-green mb-4 flex justify-between items-center"
                    >
                        <span x-text="$t('triggers')"></span>
                        <button
                            @click="addTrigger()"
                            class="w-6 h-6 flex items-center justify-center bg-wa-green/20 hover:bg-wa-green/40 text-wa-green hover:text-white text-lg leading-none transition-colors rounded-lg"
                            :title="$t('add_trigger')">+</button
                        >
                    </div>

                    <!-- Flow Global Settings -->
                    <div class="mb-4 bg-wa-bg-deep p-3 border border-wa-border rounded-lg">
                        <h4
                            class="text-[10px] text-wa-text-secondary font-sans mb-2"
                        >
                            Flow Limits & Rules
                        </h4>
                        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-3">
                            <div class="flex-1">
                                <label
                                    class="block text-[10px] text-wa-text-secondary font-sans mb-1"
                                    x-text="$t('usage_limit')"></label>
                                <select
                                    x-model="flow.usageLimit"
                                    class="w-full bg-wa-bg-hover text-gray-200 text-xs px-2 py-1.5 border border-wa-border focus:outline-none focus:border-wa-green rounded-lg"
                                >
                                    <option
                                        value="0"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >&#8734;</option
                                    >
                                    <option
                                        value="1"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >1x</option
                                    >
                                    <option
                                        value="3"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >3x</option
                                    >
                                    <option
                                        value="5"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >5x</option
                                    >
                                    <option
                                        value="10"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >10x</option
                                    >
                                </select>
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-[10px] text-wa-text-secondary font-sans mb-1"
                                    x-text="$t('cooldown')"></label>
                                <select
                                    x-model="flow.cooldownMs"
                                    class="w-full bg-wa-bg-hover text-gray-200 text-xs px-2 py-1.5 border border-wa-border focus:outline-none focus:border-wa-green rounded-lg"
                                >
                                    <option
                                        value="0"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >-</option
                                    >
                                    <option
                                        value="60000"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >1min</option
                                    >
                                    <option
                                        value="300000"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >5min</option
                                    >
                                    <option
                                        value="3600000"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >1h</option
                                    >
                                    <option
                                        value="86400000"
                                        class="bg-wa-bg-deep text-gray-300"
                                        >24h</option
                                    >
                                </select>
                            </div>
                        </div>

                        <!-- Mutual Exclusions -->
                         <div x-show="availableFlows.length > 0 || true">
                            <label class="block text-[10px] text-wa-text-secondary font-sans mb-2" title="If any of these flows have run in the session, this flow will NOT run.">
                                MUTUALLY EXCLUSIVE WITH:
                            </label>
                            <div class="max-h-32 overflow-y-auto space-y-1 pr-1 bg-wa-bg-deep/50 p-2 sm:p-2 border border-wa-border rounded-lg">
                                <template x-for="f in availableFlows" :key="f.id">
                                    <label class="flex items-center gap-2 cursor-pointer hover:bg-wa-bg-hover p-1 rounded">
                                        <input type="checkbox" :value="f.id" x-model="flow.excludesFlows" class="accent-wa-green">
                                        <span class="text-[10px] font-mono text-gray-300 truncate" x-text="f.name"></span>
                                    </label>
                                </template>
                                <div x-show="availableFlows.length === 0" class="text-[10px] text-wa-text-secondary font-sans italic p-1">
                                    (No other flows available)
                                </div>
                            </div>
                         </div>
                    </div>

                    <div class="space-y-3">
                        <template
                            x-for="(trigger, index) in flow.triggers"
                            :key="index"
                        >
                            <div
                                class="bg-wa-bg-deep p-4 border border-wa-border space-y-3 rounded-lg"
                            >
                                <!-- Row 1: Selects and Delete -->
                                <div class="flex flex-wrap justify-between items-center gap-2">
                                    <div class="flex gap-2 items-center flex-1 min-w-0">
                                        <select
                                            x-model="trigger.scope"
                                            class="bg-wa-bg-hover text-[10px] font-mono text-wa-green px-2 py-1.5 border border-wa-border focus:outline-none focus:border-wa-green flex-1 min-w-0 rounded-lg"
                                            title="Trigger Scope"
                                        >
                                            <option value="INCOMING">INCOMING</option>
                                            <option value="OUTGOING">OUTGOING</option>
                                            <option value="BOTH">ALL</option>
                                        </select>
                                        <select
                                            x-model="trigger.matchType"
                                            class="bg-wa-bg-hover text-xs font-mono text-white px-2 py-1.5 border border-wa-border focus:outline-none focus:border-wa-green flex-1 min-w-0 rounded-lg"
                                        >
                                            <template
                                                x-for="opt in ['CONTAINS', 'EXACT', 'REGEX']"
                                            >
                                                <option
                                                    :value="opt"
                                                    x-text="opt"
                                                    class="bg-wa-bg-deep"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <button
                                        @click="removeTrigger(index)"
                                        class="text-red-500 hover:text-red-400 font-bold px-2 py-1 text-lg"
                                        >&times;</button
                                    >
                                </div>

                                <!-- Row 2: Keyword Input -->
                                <div>
                                    <textarea
                                        x-model="trigger.keyword"
                                        rows="1"
                                        class="w-full bg-wa-bg-hover text-sm px-3 py-2 border border-wa-border focus:outline-none focus:border-wa-green resize-none overflow-hidden font-mono leading-relaxed min-h-[40px] max-w-full rounded-lg"
                                        :placeholder="$t('keyword') || 'Enter keyword or regex...'"
                                        x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px' })"
                                        @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                                    ></textarea>
                                </div>
                            </div>
                        </template>

                        <div
                            x-show="flow.triggers.length === 0"
                            class="text-center py-4 text-wa-text-secondary text-xs font-sans"
                            x-text="$t('no_triggers')"
                        >
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Steps Builder -->
            <div class="col-span-1 lg:col-span-2 flex flex-col h-full min-h-0">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4 shrink-0">
                    <h3
                        class="text-xs text-wa-green font-sans"
                        x-text="$t('sequence_steps')"
                    >
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button
                            @click="addStep('TEXT')"
                            class="px-3 py-1 bg-wa-bg-hover hover:bg-wa-bg-hover text-[10px] font-sans border border-wa-border rounded-lg"
                            x-text="$t('add_step_text')"></button>
                        <button
                            @click="addStep('IMAGE')"
                            class="px-3 py-1 bg-wa-bg-hover hover:bg-wa-bg-hover text-[10px] font-sans border border-wa-border rounded-lg"
                            x-text="$t('add_step_image')"></button>
                        <button
                            @click="addStep('AUDIO')"
                            class="px-3 py-1 bg-wa-bg-hover hover:bg-wa-bg-hover text-[10px] font-sans border border-wa-border rounded-lg"
                            x-text="$t('add_step_audio')"></button>
                        <button
                            @click="addStep('CONDITIONAL_TIME')"
                            class="px-3 py-1 bg-wa-green/20 text-wa-green hover:bg-wa-green/40 text-[10px] font-sans border border-wa-green/30 rounded-lg"
                            title="Time Condition"
                        >ðŸ•’ TIME</button>
                        <button
                            @click="addStep('TOOL')"
                            class="px-3 py-1 bg-purple-500/20 text-purple-400 hover:bg-purple-500/40 text-[10px] font-sans border border-purple-500/30 rounded-lg"
                            title="Execute Tool"
                        >âš¡ TOOL</button>
                    </div>
                </div>

                <div
                    class="flex-1 overflow-y-auto bg-wa-bg-panel/30 border border-wa-border relative rounded-xl"
                >
                    <div id="steps-container" class="p-3 sm:p-6 space-y-4 pb-20">
                        <template
                            x-for="(step, index) in flow.steps"
                            :key="step.tempId || step.id || index"
                        >
                            <div
                                class="step-card bg-wa-bg-deep border border-wa-border rounded-lg p-3 sm:p-4 relative group hover:border-wa-green/50 transition-colors overflow-hidden"
                                :data-id="index"
                            >
                                <!-- Reorder Controls -->
                                <div
                                    class="absolute left-2 top-4 flex flex-col gap-1 items-center z-10 w-6"
                                >
                                    <button
                                        @click="moveUp(index)"
                                        class="text-wa-text-secondary hover:text-wa-green text-[10px] leading-none p-1 disabled:opacity-20 disabled:cursor-not-allowed transition-colors"
                                        :disabled="index === 0"
                                    >â–²</button>

                                    <div class="text-wa-text-secondary cursor-move handle py-1 hover:text-white select-none" title="Drag">â‹®â‹®</div>

                                    <button
                                        @click="moveDown(index)"
                                        class="text-wa-text-secondary hover:text-wa-green text-[10px] leading-none p-1 disabled:opacity-20 disabled:cursor-not-allowed transition-colors"
                                        :disabled="index === flow.steps.length - 1"
                                    >â–¼</button>
                                </div>

                                <div class="pl-8 sm:pl-10">
                                    <div
                                        class="flex flex-wrap justify-between text-xs font-sans text-wa-text-secondary mb-3 tracking-wide items-center gap-2"
                                    >
                                        <span
                                            x-text="step.type"
                                            class="text-wa-green font-bold shrink-0"
                                        ></span>
                                        <div
                                            class="flex gap-2 sm:gap-4 items-center flex-wrap"
                                        >
                                            <span
                                                class="flex items-center gap-1 text-wa-text-secondary"
                                            >
                                                <span x-text="$t('delay')"
                                                ></span>:
                                                <input
                                                    type="number"
                                                    x-model="step.delayMs"
                                                    class="w-14 sm:w-16 bg-wa-bg-hover text-center px-1 sm:px-2 py-1 border border-wa-border focus:outline-none focus:border-wa-green text-white rounded-lg"
                                                    min="0"
                                                /><span class="text-wa-text-secondary"
                                                    >ms</span
                                                >
                                            </span>
                                            <span
                                                class="flex items-center gap-1 text-wa-text-secondary"
                                            >
                                                <span class="text-wa-text-secondary"
                                                    >Â±</span
                                                >
                                                <input
                                                    type="number"
                                                    x-model="step.jitterPct"
                                                    class="w-12 sm:w-14 bg-wa-bg-hover text-center px-1 sm:px-2 py-1 border border-wa-border focus:outline-none focus:border-wa-green text-white rounded-lg"
                                                    min="0"
                                                    max="100"
                                                /><span class="text-wa-text-secondary"
                                                    >%</span
                                                >
                                            </span>
                                            <button
                                                @click="removeStep(index)"
                                                class="text-red-500 hover:text-white px-2 py-1 hover:bg-red-500/20 transition-colors rounded-lg"
                                                x-text="$t('remove')"></button>
                                        </div>
                                    </div>

                                    <!-- Step Content -->
                                    <div class="space-y-2">
                                        <template x-if="step.type === 'TEXT'">
                                            <textarea
                                                x-model="step.content"
                                                rows="2"
                                                class="w-full max-w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-sm focus:border-wa-green focus:outline-none resize-none overflow-hidden font-mono leading-relaxed min-h-[60px] rounded-lg"
                                                :placeholder="$t('message_content')"
                                                x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px' })"
                                                @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                                            ></textarea>
                                        </template>

                                        <template
                                            x-if="['IMAGE', 'AUDIO', 'VIDEO', 'DOCUMENT'].includes(step.type)"
                                        >
                                            <div>
                                                <div class="flex flex-col sm:flex-row gap-2 mb-2">
                                                    <input
                                                        type="text"
                                                        x-model="step.mediaUrl"
                                                        class="flex-1 min-w-0 bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg"
                                                        :placeholder="$t('media_url_placeholder')"
                                                    />
                                                    <button
                                                        @click="selectMedia(index)"
                                                        class="bg-wa-bg-hover px-3 py-2 sm:py-0 text-xs hover:bg-wa-bg-hover shrink-0 rounded-lg"
                                                        x-text="$t('select_media')"
                                                    ></button>
                                                </div>
                                                <template
                                                    x-if="step.type === 'IMAGE' && step.mediaUrl"
                                                >
                                                    <img
                                                        :src="step.mediaUrl"
                                                        class="h-24 opacity-50 hover:opacity-100 transition-opacity border border-wa-border rounded-lg"
                                                    />
                                                </template>
                                                <template
                                                    x-if="step.type === 'IMAGE'"
                                                >
                                                    <textarea
                                                        x-model="step.content"
                                                        rows="1"
                                                        class="w-full max-w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs mt-1 focus:border-wa-green focus:outline-none resize-none overflow-hidden font-mono leading-relaxed min-h-[40px] rounded-lg"
                                                        :placeholder="$t('caption_placeholder')"
                                                        x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px' })"
                                                        @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                                                    ></textarea>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Tool Step -->
                                        <template x-if="step.type === 'TOOL'">
                                            <div x-init="!step.metadata && (step.metadata = { toolName: '', toolArgs: {} }); !step.metadata.toolArgs && (step.metadata.toolArgs = {})"
                                                 x-effect="$watch('step.metadata.toolName', () => { step.metadata.toolArgs = {} })">
                                                <div class="text-[10px] text-wa-text-secondary font-sans mb-2">Select a tool to execute:</div>
                                                <select
                                                    x-model="step.metadata.toolName"
                                                    class="w-full bg-wa-bg-hover text-gray-200 text-xs px-2 py-1.5 border border-wa-border focus:outline-none focus:border-purple-400 rounded-lg font-mono"
                                                >
                                                    <option value="">-- Select tool --</option>
                                                    <optgroup label="Built-in">
                                                        <option value="toggle_session_ai">toggle_session_ai</option>
                                                        <option value="clear_conversation">clear_conversation</option>
                                                        <option value="get_current_time">get_current_time</option>
                                                        <option value="get_labels">get_labels</option>
                                                        <option value="assign_label">assign_label</option>
                                                        <option value="remove_label">remove_label</option>
                                                        <option value="get_sessions_by_label">get_sessions_by_label</option>
                                                        <option value="reply_to_message">reply_to_message</option>
                                                        <option value="send_followup_message">send_followup_message</option>
                                                    </optgroup>
                                                    <optgroup label="Custom" x-show="availableTools.length > 0">
                                                        <template x-for="tool in availableTools" :key="tool.name">
                                                            <option :value="tool.name" x-text="tool.name"></option>
                                                        </template>
                                                    </optgroup>
                                                </select>

                                                <!-- Tool Args: No config tools -->
                                                <div x-show="['toggle_session_ai', 'clear_conversation', 'get_labels'].includes(step.metadata.toolName)" class="mt-3">
                                                    <span class="inline-block bg-wa-bg-deep/50 border border-wa-border text-wa-text-secondary text-[10px] font-mono px-2 py-1 rounded-lg">No requiere configuraciÃ³n</span>
                                                </div>

                                                <!-- Tool Args: assign_label -->
                                                <div x-show="step.metadata.toolName === 'assign_label'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">Etiqueta <span class="text-red-400">*</span></label>
                                                    <div class="flex flex-wrap gap-2">
                                                        <template x-for="lbl in botLabels" :key="lbl.id">
                                                            <button type="button"
                                                                @click="step.metadata.toolArgs.label_name = (step.metadata.toolArgs.label_name === lbl.name ? '' : lbl.name)"
                                                                class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all border cursor-pointer select-none"
                                                                :class="step.metadata.toolArgs.label_name === lbl.name
                                                                    ? 'bg-purple-500/15 border-purple-500/40 text-purple-400'
                                                                    : 'bg-wa-bg-hover border-wa-border text-wa-text-secondary hover:border-wa-text-secondary'"
                                                            >
                                                                <span class="w-2.5 h-2.5 rounded-full shrink-0" :style="'background:' + getLabelColor(lbl.color)"></span>
                                                                <span x-text="lbl.name"></span>
                                                            </button>
                                                        </template>
                                                        <span x-show="botLabels.length === 0" class="text-wa-text-secondary text-xs py-1">No hay etiquetas sincronizadas</span>
                                                    </div>
                                                </div>

                                                <!-- Tool Args: remove_label -->
                                                <div x-show="step.metadata.toolName === 'remove_label'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">Etiqueta <span class="text-red-400">*</span></label>
                                                    <div class="flex flex-wrap gap-2">
                                                        <template x-for="lbl in botLabels" :key="lbl.id">
                                                            <button type="button"
                                                                @click="step.metadata.toolArgs.label_name = (step.metadata.toolArgs.label_name === lbl.name ? '' : lbl.name)"
                                                                class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all border cursor-pointer select-none"
                                                                :class="step.metadata.toolArgs.label_name === lbl.name
                                                                    ? 'bg-red-500/15 border-red-500/40 text-red-400'
                                                                    : 'bg-wa-bg-hover border-wa-border text-wa-text-secondary hover:border-wa-text-secondary'"
                                                            >
                                                                <span class="w-2.5 h-2.5 rounded-full shrink-0" :style="'background:' + getLabelColor(lbl.color)"></span>
                                                                <span x-text="lbl.name"></span>
                                                            </button>
                                                        </template>
                                                        <span x-show="botLabels.length === 0" class="text-wa-text-secondary text-xs py-1">No hay etiquetas sincronizadas</span>
                                                    </div>
                                                </div>

                                                <!-- Tool Args: get_current_time -->
                                                <div x-show="step.metadata.toolName === 'get_current_time'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">timezone</label>
                                                    <input type="text" x-model="step.metadata.toolArgs.timezone" placeholder="America/Mexico_City"
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none">
                                                </div>

                                                <!-- Tool Args: get_sessions_by_label -->
                                                <div x-show="step.metadata.toolName === 'get_sessions_by_label'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">Etiqueta <span class="text-red-400">*</span></label>
                                                    <div class="flex flex-wrap gap-2">
                                                        <template x-for="lbl in botLabels" :key="lbl.id">
                                                            <button type="button"
                                                                @click="step.metadata.toolArgs.label_name = (step.metadata.toolArgs.label_name === lbl.name ? '' : lbl.name)"
                                                                class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all border cursor-pointer select-none"
                                                                :class="step.metadata.toolArgs.label_name === lbl.name
                                                                    ? 'bg-purple-500/15 border-purple-500/40 text-purple-400'
                                                                    : 'bg-wa-bg-hover border-wa-border text-wa-text-secondary hover:border-wa-text-secondary'"
                                                            >
                                                                <span class="w-2.5 h-2.5 rounded-full shrink-0" :style="'background:' + getLabelColor(lbl.color)"></span>
                                                                <span x-text="lbl.name"></span>
                                                            </button>
                                                        </template>
                                                        <span x-show="botLabels.length === 0" class="text-wa-text-secondary text-xs py-1">No hay etiquetas sincronizadas</span>
                                                    </div>
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">include_messages</label>
                                                    <input type="number" x-model.number="step.metadata.toolArgs.include_messages" placeholder="5"
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none">
                                                </div>

                                                <!-- Tool Args: reply_to_message -->
                                                <div x-show="step.metadata.toolName === 'reply_to_message'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">message_id <span class="text-red-400">*</span></label>
                                                    <input type="text" x-model="step.metadata.toolArgs.message_id" required
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">text <span class="text-red-400">*</span></label>
                                                    <textarea x-model="step.metadata.toolArgs.text" rows="2" required
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none resize-none"></textarea>
                                                </div>

                                                <!-- Tool Args: send_followup_message -->
                                                <div x-show="step.metadata.toolName === 'send_followup_message'" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">session_id <span class="text-red-400">*</span></label>
                                                    <input type="text" x-model="step.metadata.toolArgs.session_id" required
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">message <span class="text-red-400">*</span></label>
                                                    <textarea x-model="step.metadata.toolArgs.message" rows="2" required
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none resize-none"></textarea>
                                                </div>

                                                <!-- Tool Args: Custom tools (JSON textarea) -->
                                                <div x-show="step.metadata.toolName && !['toggle_session_ai','clear_conversation','get_labels','assign_label','remove_label','get_current_time','get_sessions_by_label','reply_to_message','send_followup_message'].includes(step.metadata.toolName)" class="mt-3 space-y-2">
                                                    <label class="text-[10px] text-wa-text-secondary font-sans">Arguments (JSON)</label>
                                                    <textarea
                                                        :value="JSON.stringify(step.metadata.toolArgs, null, 2)"
                                                        @change="try { step.metadata.toolArgs = JSON.parse($event.target.value) } catch(e) {}"
                                                        rows="3"
                                                        placeholder='{ "key": "value" }'
                                                        class="w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg focus:border-purple-400 focus:outline-none resize-none"
                                                    ></textarea>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Conditional Time Step -->
                                        <template x-if="step.type === 'CONDITIONAL_TIME'">
                                            <div class="space-y-4" x-init="!step.metadata && (step.metadata = { branches: [], fallback: { type: 'TEXT', content: '' } })">

                                                <template x-if="step.metadata && step.metadata.branches && step.metadata.fallback">
                                                    <div>
                                                        <div class="text-[10px] text-wa-text-secondary font-sans mb-2" x-text="$t('time_condition_desc')"></div>

                                                        <!-- Branches -->
                                                        <template x-for="(branch, bIndex) in step.metadata.branches" :key="bIndex">
                                                            <div class="bg-wa-bg-deep/50 border border-wa-border p-2 sm:p-3 relative group/branch rounded-lg">
                                                                <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                                                                    <div class="flex gap-2 items-center min-w-0">
                                                                        <input type="time" x-model="branch.startTime" class="bg-wa-bg-hover text-white text-xs px-1.5 sm:px-2 py-1 border border-wa-border focus:border-wa-green focus:outline-none rounded-lg font-mono min-w-0">
                                                                        <span class="text-wa-text-secondary text-xs shrink-0">-</span>
                                                                        <input type="time" x-model="branch.endTime" class="bg-wa-bg-hover text-white text-xs px-1.5 sm:px-2 py-1 border border-wa-border focus:border-wa-green focus:outline-none rounded-lg font-mono min-w-0">
                                                                    </div>
                                                                    <button @click="step.metadata.branches.splice(bIndex, 1)" class="text-red-500 hover:text-white font-bold shrink-0">&times;</button>
                                                                </div>

                                                                <div class="flex gap-2 mb-2">
                                                                    <select x-model="branch.type" class="bg-wa-bg-hover text-[10px] text-gray-300 border border-wa-border px-2 py-1 w-full focus:outline-none font-mono rounded-lg">
                                                                        <option value="TEXT">TEXT</option>
                                                                        <option value="IMAGE">IMAGE</option>
                                                                        <option value="AUDIO">AUDIO</option>
                                                                    </select>
                                                                </div>

                                                                <div class="space-y-2">
                                                                    <textarea
                                                                        x-model="branch.content"
                                                                        rows="2"
                                                                        class="w-full max-w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs focus:border-wa-green focus:outline-none resize-none overflow-hidden min-h-[40px] font-mono rounded-lg"
                                                                        :placeholder="branch.type === 'TEXT' ? $t('message_content') : $t('caption_placeholder')"
                                                                        x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = ($el.scrollHeight + 2) + 'px' })"
                                                                        @input="$el.style.height = 'auto'; $el.style.height = ($el.scrollHeight + 2) + 'px'"></textarea>

                                                                    <div x-show="branch.type !== 'TEXT'" class="flex flex-col sm:flex-row gap-2">
                                                                        <input type="text" x-model="branch.mediaUrl" class="flex-1 min-w-0 bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg" :placeholder="$t('media_url_placeholder')">
                                                                        <button @click="selectMediaForBranch(index, bIndex)" class="bg-wa-bg-hover px-2 py-2 sm:py-0 text-[10px] hover:bg-wa-bg-hover shrink-0 rounded-lg" x-text="$t('pick')"></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>

                                                        <button @click="step.metadata.branches.push({ startTime: '09:00', endTime: '18:00', type: 'TEXT', content: '' })" class="w-full py-2 border border-dashed border-wa-border text-xs text-wa-text-secondary hover:text-wa-green hover:border-wa-green/30 transition-colors font-sans rounded-lg" x-text="'+ ' + $t('add_time_range')"></button>

                                                        <div x-show="hasOverlap(step.metadata.branches)" class="text-red-400 text-[10px] font-sans mt-2 bg-red-500/10 p-2 border border-red-500/20 flex items-center gap-2 rounded-lg">
                                                            <span>âš </span> <span x-text="$t('overlap_warning')"></span>
                                                        </div>

                                                        <!-- Fallback -->
                                                        <div class="mt-4 pt-4 border-t border-wa-border">
                                                            <div class="text-[10px] text-wa-text-secondary mb-2 font-sans" x-text="$t('fallback_label')"></div>
                                                            <div class="bg-wa-bg-deep/50 p-2 sm:p-3 border border-wa-border rounded-lg">
                                                                <div class="flex gap-2 mb-2">
                                                                    <select x-model="step.metadata.fallback.type" class="bg-wa-bg-hover text-[10px] text-gray-300 border border-wa-border px-2 py-1 w-full focus:outline-none font-mono rounded-lg">
                                                                        <option value="TEXT">TEXT</option>
                                                                        <option value="IMAGE">IMAGE</option>
                                                                        <option value="AUDIO">AUDIO</option>
                                                                    </select>
                                                                </div>
                                                                <textarea
                                                                    x-model="step.metadata.fallback.content"
                                                                    rows="2"
                                                                    class="w-full max-w-full bg-wa-bg-deep/50 border border-wa-border p-2 text-xs focus:border-wa-green focus:outline-none resize-none overflow-hidden min-h-[40px] font-mono rounded-lg"
                                                                    :placeholder="$t('message_content')"
                                                                    x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = ($el.scrollHeight + 2) + 'px' })"
                                                                    @input="$el.style.height = 'auto'; $el.style.height = ($el.scrollHeight + 2) + 'px'"></textarea>
                                                                <div x-show="step.metadata.fallback.type !== 'TEXT'" class="flex flex-col sm:flex-row gap-2 mt-2">
                                                                    <input type="text" x-model="step.metadata.fallback.mediaUrl" class="flex-1 min-w-0 bg-wa-bg-deep/50 border border-wa-border p-2 text-xs font-mono rounded-lg" :placeholder="$t('media_url_placeholder')">
                                                                    <button @click="selectMediaForFallback(index)" class="bg-wa-bg-hover px-2 py-2 sm:py-0 text-[10px] hover:bg-wa-bg-hover shrink-0 rounded-lg" x-text="$t('pick')"></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div
                            x-show="flow.steps.length === 0"
                            class="text-center py-12 text-wa-text-secondary"
                        >
                            <p
                                class="text-xs font-sans"
                                x-text="$t('empty_flow')"
                            >
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            x-show="!ready"
            class="fixed inset-0 flex items-center justify-center bg-wa-bg-deep z-50"
        >
            <div
                class="text-wa-green animate-pulse text-xs font-sans"
                x-text="$t('loading')"
            >
            </div>
        </div>
    </div>

    <MediaPicker />
</Layout>

<script>
    // @ts-ignore
    declare const Alpine: any;

    import { ApiClient } from "../lib/api";
    import Sortable from "sortablejs";

    // TS Definitions
    interface Trigger {
        keyword: string;
        matchType: string;
        scope?: string;
    }
    interface Step {
        id?: string;
        tempId?: number; // For frontend keys
        type: string;
        content: string;
        mediaUrl?: string;
        metadata?: any;
        delayMs: number;
        jitterPct: number;
        order: number;
    }
    interface Flow {
        name: string;
        description: string;
        usageLimit: number;
        cooldownMs: number;
        excludesFlows: string[];
        triggers: Trigger[];
        steps: Step[];
    }

    document.addEventListener("alpine:init", () => {
        Alpine.data("flowEditor", () => ({
            id: null as string | null,
            ready: false,
            saving: false,
            availableFlows: [] as { id: string; name: string }[],
            availableTools: [] as { name: string }[],
            botLabels: [] as { id: string; name: string; color: number }[],
            bot: { id: null } as {
                id: string | null;
                platform?: string;
                identifier?: string;
            },
            flow: {
                name: "",
                description: "",
                usageLimit: 0,
                cooldownMs: 0,
                excludesFlows: [],
                triggers: [],
                steps: [],
            } as Flow,
            botId: null as string | null,

            getBranches(step: Step) {
                if (step.type !== 'CONDITIONAL_TIME' || !step.metadata) return [];
                return step.metadata.branches || [];
            },

            getFallback(step: Step) {
                if (step.type !== 'CONDITIONAL_TIME' || !step.metadata) return { type: 'TEXT', content: '' };
                return step.metadata.fallback || { type: 'TEXT', content: '' };
            },

            hasOverlap(branches: any[]) {
                if (!branches || branches.length < 2) return false;

                // Prepare normalized ranges (handling midnight crossing)
                const ranges: { start: number, end: number }[] = [];

                branches.forEach(b => {
                    const [sh, sm] = (b.startTime || "00:00").split(':').map(Number);
                    const [eh, em] = (b.endTime || "00:00").split(':').map(Number);
                    const start = sh * 60 + sm;
                    const end = eh * 60 + em;

                    if (start < end) {
                        ranges.push({ start, end });
                    } else {
                        // Crosses midnight: Split into [start, 1440] and [0, end]
                        // e.g. 22:00 (1320) to 06:00 (360) -> [1320, 1440] and [0, 360]
                        ranges.push({ start, end: 24 * 60 });
                        ranges.push({ start: 0, end });
                    }
                });

                // Sort by start time
                ranges.sort((a, b) => a.start - b.start);

                // Check for overlaps
                for (let i = 0; i < ranges.length - 1; i++) {
                    // If current end is greater than next start, we have an overlap
                    // We use > because touching boundaries (12:00 end, 12:00 start) is usually allowed
                    if (ranges[i].end > ranges[i + 1].start) return true;
                }
                return false;
            },

            async init() {
                // Watch for ready state to trigger initial resize
                this.$watch('ready', (value) => {
                    if (value) {
                        // Wait for transition/render
                        setTimeout(() => {
                            const textareas = document.querySelectorAll('#steps-container textarea') as NodeListOf<HTMLTextAreaElement>;
                            textareas.forEach(el => {
                                el.style.height = 'auto';
                                el.style.height = (el.scrollHeight + 2) + 'px';
                            });
                        }, 300); // 300ms to be safe after x-show transition
                    }
                });

                // Client-side Router Logic
                const params = new URLSearchParams(window.location.search);
                this.id = params.get("id");
                this.botId = params.get("botId");

                if (this.id && this.id !== "new") {
                    // Editing existing flow - load flow data first
                    await this.loadFlow(this.id);
                } else if (this.botId) {
                    // Creating new flow - load bot info
                    try {
                        this.bot = await ApiClient.get(`/bots/${this.botId}`);
                    } catch (e) {
                        console.error("Failed to load bot info", e);
                    }
                    this.flow.name = "New Flow";
                    this.ready = true;
                    this.loadAvailableTools();
                    this.loadLabels();
                } else {
                    // No context, redirect to bots
                    window.location.href = "/bots";
                    return;
                }

                // Initialize Sortable
                // @ts-ignore
                this.$nextTick(() => {
                    const el = document.getElementById("steps-container");
                    if (el) {
                        Sortable.create(el, {
                            handle: ".handle",
                            draggable: ".step-card",
                            animation: 150,
                            onEnd: (evt: any) => {
                                const { oldIndex, newIndex } = evt;
                                if (oldIndex === newIndex) return;

                                // Reorder array
                                const item = this.flow.steps.splice(
                                    oldIndex,
                                    1,
                                )[0];
                                this.flow.steps.splice(newIndex, 0, item);

                                // Update order
                                this.updateOrder();
                            },
                        });
                    }
                });
            },

            updateOrder() {
                this.flow.steps.forEach((s: Step, i: number) => (s.order = i));
            },

            moveUp(index: number) {
                if (index === 0) return;
                const item = this.flow.steps.splice(index, 1)[0];
                this.flow.steps.splice(index - 1, 0, item);
                this.updateOrder();
            },

            moveDown(index: number) {
                if (index === this.flow.steps.length - 1) return;
                const item = this.flow.steps.splice(index, 1)[0];
                this.flow.steps.splice(index + 1, 0, item);
                this.updateOrder();
            },

            async loadFlow(id: string) {
                try {
                    const res = await ApiClient.get(`/flows/${id}`);
                    this.flow = res;
                    // Extract botId from flow for back navigation
                    if (res.botId) {
                        this.botId = res.botId;
                        this.bot = { id: res.botId };
                        // Optionally load full bot info
                        try {
                            this.bot = await ApiClient.get(
                                `/bots/${res.botId}`,
                            );
                        } catch (e) {
                            // Bot info is optional, continue with just ID
                        }
                    }
                    this.ready = true;
                    this.loadAvailableFlows();
                    this.loadAvailableTools();
                    this.loadLabels();
                } catch (e) {
                    alert("Failed to load flow");
                    window.location.href = "/bots";
                }
            },

            async loadAvailableTools() {
                if (!this.botId) return;
                try {
                    const tools = await ApiClient.get(`/tools?botId=${this.botId}`);
                    this.availableTools = tools.filter((t: any) => t.status === 'ACTIVE');
                } catch (e) {
                    console.error("Failed to load available tools", e);
                }
            },

            getLabelColor(color: number) {
                const colors = ['#00a884','#53bdeb','#009de2','#ff9a00','#d13b3b','#a552a1','#5bc5d1','#fc7e7e','#e8b830','#e354c5','#00d0b6','#349ded','#8c68e0','#e56e56','#a0d669','#62c5e1','#7e90e5','#e89844','#e873b0','#6ccb78'];
                return colors[color % colors.length];
            },

            async loadLabels() {
                if (!this.botId) return;
                try {
                    this.botLabels = await ApiClient.get(`/sessions/labels?botId=${this.botId}`);
                } catch (e) {
                    console.error("Failed to load labels", e);
                }
            },

            async loadAvailableFlows() {
                if (!this.botId) return;
                try {
                    // Fetch all flows for this bot to populate the exclusion list
                    // We need a lightweight list. Assuming /flows?botId=... returns list
                    const flows = await ApiClient.get(`/flows?botId=${this.botId}`);
                    // Filter out current flow
                    this.availableFlows = flows.filter((f: any) => f.id !== this.id);
                } catch (e) {
                    console.error("Failed to load available flows", e);
                }
            },

            addTrigger() {
                this.flow.triggers.push({
                    keyword: "",
                    matchType: "CONTAINS",
                    scope: "INCOMING",
                });
            },

            removeTrigger(index: number) {
                this.flow.triggers.splice(index, 1);
            },

            addStep(type: string) {
                const step: any = {
                    tempId: Date.now(),
                    type,
                    content: "",
                    mediaUrl: "",
                    delayMs: 1000,
                    jitterPct: 10,
                    order: this.flow.steps.length,
                };
                if (type === 'TOOL') {
                    step.metadata = { toolName: '' };
                }
                this.flow.steps.push(step);

                // @ts-ignore
                this.$nextTick(() => {
                    const container =
                        document.getElementById("steps-container");
                    if (container) container.scrollTop = container.scrollHeight;
                });
            },

            removeStep(index: number) {
                this.flow.steps.splice(index, 1);
            },

            selectMedia(stepIndex: number) {
                window.dispatchEvent(
                    new CustomEvent("open-media-picker", {
                        detail: {
                            callback: (url: string) => {
                                if (this.flow.steps[stepIndex]) {
                                    this.flow.steps[stepIndex].mediaUrl = url;
                                }
                            },
                        },
                    }),
                );
            },

            async save() {
                if (!this.flow.name) return alert("Name Required");

                this.saving = true;
                try {
                    // Normalize steps order and convert numeric types
                    this.flow.steps.forEach((s: Step, i: number) => {
                        s.order = i;
                        s.delayMs = parseInt(s.delayMs as any, 10) || 1000;
                        s.jitterPct = parseInt(s.jitterPct as any, 10) || 10;
                    });

                    // Convert trigger numeric types is no longer needed/relevant for limits, but kept for robustness if other fields exist

                    if (!this.id || this.id === "new") {
                        // Create
                        const params = new URLSearchParams(
                            window.location.search,
                        );
                        const botId = params.get("botId");

                        if (!botId) throw new Error("Missing Bot Context");

                        const res = await ApiClient.post("/flows", {
                            ...this.flow,
                            botId,
                        });
                        // Redirect to edit mode
                        window.location.href = `/editor?id=${res.id}`;
                    } else {
                        // Update
                        await ApiClient.put(`/flows/${this.id}`, this.flow);
                        alert("Saved!");
                    }
                } catch (e) {
                    alert("Error saving flow");
                    console.error(e);
                } finally {
                    this.saving = false;
                }
            },
        }));
    });
</script>
