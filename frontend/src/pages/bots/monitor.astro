---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Monitor">
    <div
        x-data="botMonitor"
        class="h-[calc(100vh-4rem)] flex flex-col"
    >
        <!-- Header -->
        <header class="flex items-center justify-between border-b border-wa-border pb-4 mb-4 flex-shrink-0">
            <div class="flex items-center gap-3">
                <a href="#" @click.prevent="goBack()" class="text-wa-text-secondary hover:text-wa-green transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-bold tracking-tight" x-text="$t('monitor')">Monitor</h1>
                <span class="text-[10px] font-sans text-wa-green bg-wa-green/10 px-2 py-0.5" x-show="botName" x-text="botName"></span>
            </div>
        </header>

        <!-- Two-panel layout -->
        <div class="flex-1 flex gap-4 min-h-0">

            <!-- Left: Sessions list -->
            <div
                class="flex-col bg-wa-bg-panel border border-wa-border rounded-xl overflow-hidden min-h-0"
                :class="selectedSession ? 'hidden md:flex md:w-80 md:flex-shrink-0' : 'flex w-full md:w-80 md:flex-shrink-0'"
            >
                <!-- Search -->
                <div class="p-3 border-b border-wa-border">
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input.debounce.300ms="loadSessions()"
                        class="w-full bg-wa-bg-deep border border-wa-border text-white text-xs p-2 rounded-lg focus:border-wa-green focus:outline-none placeholder-wa-text-secondary"
                        :placeholder="$t('search_sessions')"
                    />
                </div>

                <!-- Session items -->
                <div class="flex-1 overflow-y-auto">
                    <template x-if="sessions.length === 0">
                        <div class="p-6 text-center text-xs text-wa-text-secondary font-sans" x-text="$t('no_sessions')"></div>
                    </template>

                    <template x-for="s in sessions" :key="s.id">
                        <button
                            @click="selectSession(s)"
                            class="w-full text-left p-3 border-b border-wa-border hover:bg-wa-bg-hover transition-colors"
                            :class="selectedSession?.id === s.id ? 'bg-wa-green/10 border-l-2 border-l-wa-green' : ''"
                        >
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm text-white truncate" x-text="s.name || s.identifier"></div>
                                    <div class="text-[10px] text-wa-text-secondary font-sans truncate" x-text="s.identifier"></div>
                                </div>
                                <div class="flex flex-col items-end flex-shrink-0 ml-2">
                                    <span class="text-[10px] text-wa-text-secondary" x-text="relativeTime(s.lastMessage?.createdAt || s.updatedAt)"></span>
                                    <span class="text-[10px] text-wa-text-secondary font-sans" x-text="s.messageCount + ' msgs'"></span>
                                </div>
                            </div>
                            <div x-show="s.lastMessage" class="mt-1 text-xs text-wa-text-secondary truncate" x-text="s.lastMessage?.content || ''"></div>
                            <div x-show="s.labels?.length" class="mt-1.5 flex flex-wrap gap-1">
                                <template x-for="lbl in (s.labels || [])" :key="lbl.id">
                                    <span
                                        class="text-[9px] font-sans px-1.5 py-0.5 rounded-full text-white/90"
                                        :style="`background:${labelColor(lbl.color)}`"
                                        x-text="lbl.name"
                                    ></span>
                                </template>
                            </div>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Right: Chat panel -->
            <div
                class="flex-1 flex-col bg-wa-bg-panel border border-wa-border rounded-xl overflow-hidden min-h-0"
                :class="selectedSession ? 'flex' : 'hidden md:flex'"
            >
                <!-- No session selected -->
                <template x-if="!selectedSession">
                    <div class="flex-1 flex items-center justify-center">
                        <p class="text-xs font-sans text-wa-text-secondary" x-text="$t('no_sessions')"></p>
                    </div>
                </template>

                <!-- Session selected -->
                <template x-if="selectedSession">
                    <div class="flex flex-col h-full min-h-0">
                        <!-- Chat header -->
                        <div class="p-4 border-b border-wa-border flex-shrink-0">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 min-w-0">
                                    <!-- Back button (mobile only) -->
                                    <button
                                        @click="selectedSession = null"
                                        class="md:hidden text-wa-text-secondary hover:text-wa-green transition-colors flex-shrink-0"
                                    >
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="min-w-0">
                                        <div class="font-bold text-sm truncate" x-text="selectedSession.name || selectedSession.identifier"></div>
                                        <div class="text-[10px] text-wa-text-secondary font-sans truncate" x-text="selectedSession.identifier"></div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="selectedSession.status === 'CONNECTED' ? 'bg-green-500' : 'bg-gray-600'"></span>
                                    <span class="text-[10px] font-sans text-wa-text-secondary" x-text="selectedSession.status"></span>
                                </div>
                            </div>
                            <!-- Labels row -->
                            <div class="mt-2 flex flex-wrap items-center gap-1.5">
                                <template x-for="lbl in (selectedSession.labels || [])" :key="lbl.id">
                                    <button
                                        @click="removeLabel(lbl.id)"
                                        class="inline-flex items-center gap-1 text-[10px] font-sans px-2 py-0.5 rounded-full text-white/90 hover:opacity-80 transition-opacity cursor-pointer"
                                        :style="`background:${labelColor(lbl.color)}`"
                                        :title="'Remove ' + lbl.name"
                                    >
                                        <span x-text="lbl.name"></span>
                                        <svg class="w-3 h-3 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </template>
                                <!-- Add label dropdown -->
                                <div class="relative" x-data="{ open: false }">
                                    <button
                                        @click="open = !open"
                                        x-show="availableLabels().length > 0"
                                        class="text-[10px] font-sans px-2 py-0.5 border border-wa-border text-wa-text-secondary rounded-full hover:border-wa-green hover:text-wa-green transition-colors"
                                    >+ Label</button>
                                    <div
                                        x-show="open"
                                        @click.outside="open = false"
                                        class="absolute top-full left-0 mt-1 z-50 bg-wa-bg-deep border border-wa-border rounded shadow-lg min-w-[160px] max-h-48 overflow-y-auto"
                                        style="display: none;"
                                    >
                                        <template x-for="lbl in availableLabels()" :key="lbl.id">
                                            <button
                                                @click="assignLabel(lbl.id); open = false"
                                                class="w-full text-left px-3 py-1.5 text-xs hover:bg-wa-bg-hover flex items-center gap-2"
                                            >
                                                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" :style="`background:${labelColor(lbl.color)}`"></span>
                                                <span x-text="lbl.name"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages area -->
                        <div
                            x-ref="messagesContainer"
                            class="flex-1 overflow-y-auto p-4 space-y-3 min-h-0"
                        >
                            <template x-if="messages.length === 0">
                                <div class="flex items-center justify-center h-full">
                                    <p class="text-xs font-sans text-wa-text-secondary" x-text="$t('no_messages')"></p>
                                </div>
                            </template>

                            <template x-for="msg in messages" :key="msg.id">
                                <div class="flex" :class="msg.fromMe ? 'justify-end' : 'justify-start'">
                                    <div
                                        class="max-w-[85%] md:max-w-[70%] px-3 py-2 rounded-lg text-sm break-words"
                                        :class="msg.fromMe
                                            ? 'bg-wa-bubble-out text-white rounded-br-none'
                                            : 'bg-wa-bubble-in text-white rounded-bl-none'"
                                    >
                                        <!-- Type badge for non-text -->
                                        <span
                                            x-show="msg.type !== 'TEXT'"
                                            class="inline-block text-[9px] font-sans bg-white/10 px-1 py-0.5 rounded mb-1 uppercase"
                                            x-text="msg.type"
                                        ></span>
                                        <div x-text="msg.content || '[media]'" class="whitespace-pre-wrap"></div>
                                        <div class="text-[10px] text-wa-text-secondary mt-1 text-right" x-text="formatTime(msg.createdAt)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Input area -->
                        <div class="p-3 border-t border-wa-border flex-shrink-0 space-y-2">
                            <!-- Message input -->
                            <form @submit.prevent="sendMessage()" class="flex gap-2">
                                <input
                                    type="text"
                                    x-model="messageInput"
                                    class="flex-1 min-w-0 bg-wa-bg-deep border border-wa-border text-white text-sm p-2 rounded-lg focus:border-wa-green focus:outline-none placeholder-wa-text-secondary"
                                    :placeholder="$t('type_message')"
                                />
                                <button
                                    type="submit"
                                    :disabled="!messageInput.trim() || sending"
                                    class="flex-shrink-0 px-4 py-2 bg-wa-green text-white text-xs font-sans hover:bg-wa-green-hover transition-colors disabled:opacity-50 rounded-lg"
                                >
                                    <!-- Icon for mobile -->
                                    <svg class="w-4 h-4 md:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                    </svg>
                                    <!-- Text for desktop -->
                                    <span class="hidden md:inline" x-text="$t('send_message')"></span>
                                </button>
                            </form>

                            <!-- Action buttons -->
                            <div class="flex gap-2 flex-wrap">
                                <button
                                    @click="showForceAIModal = true"
                                    class="px-3 py-1.5 border border-yellow-500/30 text-yellow-400 text-[10px] font-sans hover:bg-yellow-500/10 transition-colors rounded-lg"
                                    x-text="$t('force_ai')"
                                ></button>
                                <button
                                    @click="openFlowModal()"
                                    class="px-3 py-1.5 border border-blue-500/30 text-blue-400 text-[10px] font-sans hover:bg-blue-500/10 transition-colors rounded-lg"
                                    x-text="$t('run_flow')"
                                ></button>
                                <button
                                    @click="openToolModal()"
                                    class="px-3 py-1.5 border border-green-500/30 text-green-400 text-[10px] font-sans hover:bg-green-500/10 transition-colors rounded-lg"
                                    x-text="$t('run_tool')"
                                ></button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Force AI Modal -->
        <div
            x-show="showForceAIModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"
            style="display: none;"
        >
            <div class="bg-wa-bg-panel border border-wa-border p-6 max-w-md w-full rounded-xl" @click.outside="showForceAIModal = false">
                <h3 class="text-sm font-bold mb-2" x-text="$t('force_ai')"></h3>
                <p class="text-xs text-wa-text-secondary mb-4" x-text="$t('force_ai_desc')"></p>
                <textarea
                    x-model="forceAIContext"
                    rows="3"
                    class="w-full bg-wa-bg-hover border border-wa-border text-white text-sm p-3 focus:border-wa-green focus:outline-none resize-y mb-4"
                    :placeholder="$t('force_ai_context')"
                ></textarea>
                <div class="flex justify-end gap-2">
                    <button
                        @click="showForceAIModal = false"
                        class="px-4 py-2 border border-wa-border text-wa-text-secondary text-xs hover:bg-wa-bg-hover transition-colors rounded-lg"
                        x-text="$t('cancel')"
                    ></button>
                    <button
                        @click="forceAI()"
                        class="px-4 py-2 bg-yellow-600 text-white text-xs hover:bg-yellow-700 transition-colors rounded-lg"
                        x-text="$t('confirm')"
                    ></button>
                </div>
            </div>
        </div>

        <!-- Run Flow Modal -->
        <div
            x-show="showFlowModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"
            style="display: none;"
        >
            <div class="bg-wa-bg-panel border border-wa-border p-6 max-w-md w-full rounded-xl" @click.outside="showFlowModal = false">
                <h3 class="text-sm font-bold mb-4" x-text="$t('run_flow')"></h3>
                <select
                    x-model="selectedFlowId"
                    class="w-full bg-wa-bg-hover border border-wa-border text-white text-sm p-3 focus:border-wa-green focus:outline-none mb-4"
                >
                    <option value="" x-text="$t('select_flow')"></option>
                    <template x-for="f in flows" :key="f.id">
                        <option :value="f.id" x-text="f.name"></option>
                    </template>
                </select>
                <div class="flex justify-end gap-2">
                    <button
                        @click="showFlowModal = false"
                        class="px-4 py-2 border border-wa-border text-wa-text-secondary text-xs hover:bg-wa-bg-hover transition-colors rounded-lg"
                        x-text="$t('cancel')"
                    ></button>
                    <button
                        @click="executeFlow()"
                        :disabled="!selectedFlowId"
                        class="px-4 py-2 bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 rounded-lg"
                        x-text="$t('execute')"
                    ></button>
                </div>
            </div>
        </div>

        <!-- Run Tool Modal -->
        <div
            x-show="showToolModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"
            style="display: none;"
        >
            <div class="bg-wa-bg-panel border border-wa-border p-6 max-w-md w-full rounded-xl" @click.outside="showToolModal = false">
                <h3 class="text-sm font-bold mb-4" x-text="$t('run_tool')"></h3>
                <select
                    x-model="selectedToolName"
                    class="w-full bg-wa-bg-hover border border-wa-border text-white text-sm p-3 focus:border-wa-green focus:outline-none mb-3"
                >
                    <option value="" x-text="$t('select_tool')"></option>
                    <template x-for="tool in tools" :key="tool.id">
                        <option :value="tool.name" x-text="tool.name"></option>
                    </template>
                </select>
                <label class="block text-[10px] font-sans text-wa-text-secondary mb-1" x-text="$t('tool_arguments')"></label>
                <textarea
                    x-model="toolArgsJson"
                    rows="4"
                    class="w-full bg-wa-bg-hover border border-wa-border text-white text-xs font-mono p-3 focus:border-wa-green focus:outline-none resize-y mb-4"
                    placeholder='{ "key": "value" }'
                ></textarea>
                <div class="flex justify-end gap-2">
                    <button
                        @click="showToolModal = false"
                        class="px-4 py-2 border border-wa-border text-wa-text-secondary text-xs hover:bg-wa-bg-hover transition-colors rounded-lg"
                        x-text="$t('cancel')"
                    ></button>
                    <button
                        @click="executeTool()"
                        :disabled="!selectedToolName"
                        class="px-4 py-2 bg-green-600 text-white text-xs hover:bg-green-700 transition-colors disabled:opacity-50 rounded-lg"
                        x-text="$t('execute')"
                    ></button>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    declare const Alpine: any;
    import { ApiClient } from "../../lib/api";

    document.addEventListener("alpine:init", () => {
        Alpine.data("botMonitor", () => ({
            botId: null as string | null,
            botName: "",
            sessions: [] as any[],
            selectedSession: null as any,
            messages: [] as any[],
            messageInput: "",
            searchQuery: "",
            sending: false,

            // Modals
            showForceAIModal: false,
            showFlowModal: false,
            showToolModal: false,
            forceAIContext: "",
            selectedFlowId: "",
            selectedToolName: "",
            toolArgsJson: "{}",

            // Data for modals
            flows: [] as any[],
            tools: [] as any[],

            // Labels
            botLabels: [] as any[],

            // Polling
            pollInterval: null as ReturnType<typeof setInterval> | null,
            lastMessageCount: 0,

            async init() {
                const params = new URLSearchParams(window.location.search);
                this.botId = params.get("botId");

                if (!this.botId) return;

                try {
                    const bot = await ApiClient.get(`/bots/${this.botId}`);
                    this.botName = bot.name;
                } catch {}

                await this.loadSessions();
                await this.loadLabels();

                // Start polling
                this.pollInterval = setInterval(() => this.poll(), 3000);
            },

            destroy() {
                if (this.pollInterval) clearInterval(this.pollInterval);
            },

            goBack() {
                if (this.botId) {
                    window.location.href = `/bots/detail?id=${this.botId}`;
                } else {
                    window.location.href = "/bots";
                }
            },

            async loadSessions() {
                try {
                    const params = new URLSearchParams();
                    if (this.botId) params.append("botId", this.botId);
                    if (this.searchQuery) params.append("search", this.searchQuery);
                    this.sessions = await ApiClient.get(`/sessions?${params.toString()}`);
                } catch (e) {
                    console.error("Failed to load sessions", e);
                }
            },

            async selectSession(session: any) {
                this.selectedSession = session;
                await this.loadMessages();
            },

            async loadMessages() {
                if (!this.selectedSession) return;
                try {
                    const res = await ApiClient.get(`/sessions/${this.selectedSession.id}/messages?limit=100`);
                    this.messages = res.data;
                    this.lastMessageCount = res.pagination.total;
                    this.$nextTick(() => this.scrollToBottom());
                } catch (e) {
                    console.error("Failed to load messages", e);
                }
            },

            async poll() {
                await this.loadSessions();
                if (this.selectedSession) {
                    try {
                        const res = await ApiClient.get(`/sessions/${this.selectedSession.id}/messages?limit=100`);
                        if (res.pagination.total !== this.lastMessageCount) {
                            this.messages = res.data;
                            this.lastMessageCount = res.pagination.total;
                            this.$nextTick(() => this.scrollToBottom());
                        }
                    } catch {}
                }
            },

            scrollToBottom() {
                const container = this.$refs.messagesContainer as HTMLElement;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            },

            async sendMessage() {
                if (!this.messageInput.trim() || !this.selectedSession) return;
                this.sending = true;
                try {
                    await ApiClient.post(`/sessions/${this.selectedSession.id}/send`, {
                        text: this.messageInput,
                    });
                    this.messageInput = "";
                    await this.loadMessages();
                } catch (e: any) {
                    alert("Send failed: " + (e.message || "Unknown error"));
                } finally {
                    this.sending = false;
                }
            },

            async forceAI() {
                if (!this.selectedSession) return;
                try {
                    await ApiClient.post(`/sessions/${this.selectedSession.id}/force-ai`, {
                        context: this.forceAIContext || undefined,
                    });
                    this.showForceAIModal = false;
                    this.forceAIContext = "";
                    // Wait a bit then reload messages
                    setTimeout(() => this.loadMessages(), 2000);
                } catch (e: any) {
                    alert("Force AI failed: " + (e.message || "Unknown error"));
                }
            },

            async openFlowModal() {
                if (!this.botId) return;
                try {
                    this.flows = await ApiClient.get(`/flows?botId=${this.botId}`);
                } catch {}
                this.selectedFlowId = "";
                this.showFlowModal = true;
            },

            async executeFlow() {
                if (!this.selectedSession || !this.selectedFlowId) return;
                try {
                    await ApiClient.post(`/sessions/${this.selectedSession.id}/execute-flow`, {
                        flowId: this.selectedFlowId,
                    });
                    this.showFlowModal = false;
                    setTimeout(() => this.loadMessages(), 2000);
                } catch (e: any) {
                    alert("Execute flow failed: " + (e.message || "Unknown error"));
                }
            },

            async openToolModal() {
                if (!this.botId) return;
                try {
                    this.tools = await ApiClient.get(`/tools?botId=${this.botId}`);
                } catch {}
                this.selectedToolName = "";
                this.toolArgsJson = "{}";
                this.showToolModal = true;
            },

            async executeTool() {
                if (!this.selectedSession || !this.selectedToolName) return;
                let args: Record<string, any> = {};
                try {
                    args = JSON.parse(this.toolArgsJson);
                } catch {
                    alert("Invalid JSON in arguments");
                    return;
                }
                try {
                    const res = await ApiClient.post(`/sessions/${this.selectedSession.id}/execute-tool`, {
                        toolName: this.selectedToolName,
                        args,
                    });
                    this.showToolModal = false;
                    alert("Tool result: " + JSON.stringify(res.result, null, 2));
                } catch (e: any) {
                    alert("Execute tool failed: " + (e.message || "Unknown error"));
                }
            },

            async loadLabels() {
                if (!this.botId) return;
                try {
                    this.botLabels = await ApiClient.get(`/sessions/labels?botId=${this.botId}`);
                } catch (e) {
                    console.error("Failed to load labels", e);
                }
            },

            async assignLabel(labelId: string) {
                if (!this.selectedSession) return;
                try {
                    await ApiClient.post(`/sessions/${this.selectedSession.id}/labels`, { labelId });
                    const label = this.botLabels.find((l: any) => l.id === labelId);
                    if (label) {
                        if (!this.selectedSession.labels) this.selectedSession.labels = [];
                        this.selectedSession.labels.push({ id: label.id, name: label.name, color: label.color, waLabelId: label.waLabelId });
                        // Also update in the sessions list
                        const s = this.sessions.find((s: any) => s.id === this.selectedSession.id);
                        if (s) s.labels = [...this.selectedSession.labels];
                    }
                } catch (e: any) {
                    alert("Assign label failed: " + (e.message || "Unknown error"));
                }
            },

            async removeLabel(labelId: string) {
                if (!this.selectedSession) return;
                try {
                    await ApiClient.delete(`/sessions/${this.selectedSession.id}/labels/${labelId}`);
                    this.selectedSession.labels = (this.selectedSession.labels || []).filter((l: any) => l.id !== labelId);
                    // Also update in the sessions list
                    const s = this.sessions.find((s: any) => s.id === this.selectedSession.id);
                    if (s) s.labels = [...this.selectedSession.labels];
                } catch (e: any) {
                    alert("Remove label failed: " + (e.message || "Unknown error"));
                }
            },

            availableLabels() {
                if (!this.selectedSession) return [];
                const assignedIds = new Set((this.selectedSession.labels || []).map((l: any) => l.id));
                return this.botLabels.filter((l: any) => !assignedIds.has(l.id));
            },

            labelColor(colorIndex: number): string {
                const colors = [
                    '#00a884', '#53bdeb', '#009de2', '#025bfe', '#7c3aed',
                    '#ff2e74', '#ef4444', '#ff9a00', '#ffcb00', '#a4c639',
                    '#00d166', '#00bfa5', '#02c6cf', '#7986cb', '#b39ddb',
                    '#f48fb1', '#9e9e9e', '#78909c', '#8d6e63', '#a1887f',
                ];
                return colors[colorIndex % colors.length] || colors[0];
            },

            relativeTime(dateStr: string) {
                if (!dateStr) return "";
                const now = Date.now();
                const then = new Date(dateStr).getTime();
                const diff = now - then;
                const minutes = Math.floor(diff / 60000);
                if (minutes < 1) return "now";
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h`;
                const days = Math.floor(hours / 24);
                return `${days}d`;
            },

            formatTime(dateStr: string) {
                if (!dateStr) return "";
                return new Date(dateStr).toLocaleString();
            },
        }));
    });
</script>
