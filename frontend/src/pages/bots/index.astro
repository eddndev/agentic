---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Bots">
	<main class="space-y-8" x-data="botList">
		<!-- Header -->
		<header
			class="flex flex-wrap justify-between items-center gap-4 border-b border-wa-border pb-6 relative"
		>
			<div>
				<h1
					class="text-3xl font-bold tracking-tight relative z-10"
					x-text="$t('bots')"
				>
					Bots
				</h1>
				<p class="text-xs text-wa-text-secondary mt-1">
					<span x-text="bots.length">0</span>
					<span x-text="$t('active_bots')">registered</span>
				</p>
			</div>

			<button
				@click="$dispatch('open-create-bot')"
				class="px-6 py-2 bg-wa-green text-white text-sm font-medium rounded-lg hover:bg-wa-green-hover transition-colors flex items-center gap-2"
			>
				<span>+</span>
				<span x-text="$t('create_bot')">Create Bot</span>
			</button>
		</header>

		<!-- Error State -->
		<div
			x-show="error"
			x-cloak
			class="p-6 border border-red-500/30 bg-red-500/10 text-red-400 text-sm rounded-xl"
			x-text="error"
			style="display: none;"
		>
		</div>

		<!-- Loading Skeleton -->
		<div
			x-show="loading"
			class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
		>
			<template x-for="i in 3">
				<div
					class="bg-wa-bg-panel border border-wa-border rounded-xl p-6 relative animate-pulse h-40"
				>
					<div class="w-16 h-4 bg-wa-bg-hover mb-4 rounded"></div>
					<div class="w-3/4 h-6 bg-wa-bg-hover mb-2 rounded"></div>
					<div class="w-1/2 h-4 bg-wa-bg-hover rounded"></div>
				</div>
			</template>
		</div>

		<!-- Bot Grid -->
		<div
			x-show="!loading"
			x-cloak
			class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
			style="display: none;"
		>
			<template x-for="bot in bots" :key="bot.id">
				<a
					:href="`/bots/detail?id=${bot.id}`"
					class="block bg-wa-bg-panel border border-wa-border rounded-xl p-6 relative group hover:border-wa-green/30 transition-all duration-300"
				>
					<!-- Platform Badge -->
					<div class="flex justify-between items-start mb-4">
						<span
							class="text-[10px] text-wa-green bg-wa-green/10 px-2 py-0.5 rounded-md"
							x-text="bot.platform"
						>
						</span>
						<svg
							class="w-4 h-4 text-wa-text-secondary group-hover:text-wa-green transition-colors"
							fill="none"
							viewBox="0 0 24 24"
							stroke="currentColor"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M9 5l7 7-7 7"></path>
						</svg>
					</div>

					<!-- Bot Info -->
					<h3
						class="text-lg font-bold tracking-tight mb-1 group-hover:text-wa-green transition-colors"
						x-text="bot.name"
					>
					</h3>
					<p
						class="text-xs text-wa-text-secondary truncate"
						x-text="bot.identifier"
					>
					</p>

					<!-- Connection Status Indicator -->
					<div
						class="mt-4 pt-4 border-t border-wa-border flex items-center gap-2"
						x-data="botStatus(bot.id)"
					>
						<span
							class="w-2 h-2 rounded-full"
							:class="connected ? 'bg-green-500' : 'bg-gray-600'"
						></span>
						<span
							class="text-[10px]"
							:class="connected ? 'text-green-500' : 'text-wa-text-secondary'"
							x-text="connected ? $t('active') : $t('disconnected')"
						>
							Checking...
						</span>
					</div>
				</a>
			</template>

			<!-- Empty State -->
			<div
				x-show="bots.length === 0"
				class="col-span-full p-12 border border-dashed border-wa-border rounded-xl text-center text-wa-text-secondary bg-wa-bg-panel/20"
			>
				<svg
					class="w-12 h-12 mx-auto mb-4 text-wa-text-secondary"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="1"
						d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"
					></path>
				</svg>
				<p
					class="text-sm mb-4"
					x-text="$t('no_bots')"
				>
					No bots registered
				</p>
				<button
					@click="$dispatch('open-create-bot')"
					class="px-6 py-2 bg-wa-green text-white hover:bg-wa-green-hover transition-colors text-sm rounded-lg"
				>
					+ <span x-text="$t('create_bot')">Create First Bot</span>
				</button>
			</div>
		</div>
	</main>

	<!-- Create Bot Modal -->
	<div
		x-data="createBotModal"
		x-show="visible"
		x-cloak
		@open-create-bot.window="open()"
		class="fixed inset-0 z-50 flex items-center justify-center p-4"
		style="display: none;"
	>
		<!-- Backdrop -->
		<div
			class="absolute inset-0 bg-black/70"
			@click="close()"
		>
		</div>

		<!-- Modal -->
		<div
			class="relative bg-wa-bg-panel border border-wa-border rounded-xl p-4 sm:p-8 w-full max-w-md"
		>
			<h2
				class="text-xl font-bold tracking-tight mb-6"
				x-text="$t('create_bot')"
			>
				Create Bot
			</h2>

			<form @submit.prevent="submit()" class="space-y-4">
				<div>
					<label
						class="block text-xs text-wa-text-secondary mb-2"
						x-text="$t('bot_name')"></label>
					<input
						type="text"
						x-model="form.name"
						required
						class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white"
						placeholder="My WhatsApp Bot"
					/>
				</div>

				<div>
					<label
						class="block text-xs text-wa-text-secondary mb-2"
						x-text="$t('bot_identifier')"></label>
					<input
						type="text"
						x-model="form.identifier"
						required
						class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white"
						placeholder="+1234567890"
					/>
				</div>

				<div>
					<label
						class="block text-xs text-wa-text-secondary mb-2"
						>Platform</label
					>
					<select
						x-model="form.platform"
						class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white"
					>
						<option value="WHATSAPP">WhatsApp</option>
						<option value="TELEGRAM">Telegram</option>
					</select>
				</div>

				<div class="flex gap-4 pt-4">
					<button
						type="button"
						@click="close()"
						class="flex-1 px-4 py-3 border border-wa-border text-wa-text-secondary text-sm rounded-lg hover:bg-wa-bg-hover"
						x-text="$t('cancel')"
					>
						Cancel
					</button>
					<button
						type="submit"
						:disabled="loading"
						class="flex-1 px-4 py-3 bg-wa-green text-white text-sm rounded-lg hover:bg-wa-green-hover disabled:opacity-50"
						x-text="loading ? $t('loading') : $t('create_bot')"
					>
						Create
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	declare const Alpine: any;
	import { ApiClient } from "../../lib/api";

	interface CreateBotForm {
		name: string;
		identifier: string;
		platform: "WHATSAPP" | "TELEGRAM";
	}

	interface Bot {
		id: string;
		name: string;
		identifier: string;
		platform: string;
		createdAt: string;
	}

	document.addEventListener("alpine:init", () => {
		// Main Bot List Component
		Alpine.data("botList", () => ({
			bots: [] as Bot[],
			loading: true,
			error: null as string | null,

			init() {
				this.fetchBots();
			},

			async fetchBots() {
				try {
					this.bots = await ApiClient.get("/bots");
				} catch (e: unknown) {
					const error = e as Error;
					this.error = error.message || "Failed to fetch bots";
					console.error(e);
				} finally {
					this.loading = false;
				}
			},
		}));

		// Bot Status Component (CSR)
		Alpine.data("botStatus", (botId: string) => ({
			connected: false,
			init() {
				// Don't block the UI, check status quietly
				setTimeout(() => this.checkStatus(), 100);
			},
			async checkStatus() {
				try {
					const status = await ApiClient.get(`/bots/${botId}/status`);
					this.connected = status.connected;
				} catch (e) {
					// Silent fail is fine for status indicator
					this.connected = false;
				}
			},
		}));

		// Create Bot Modal Component
		Alpine.data("createBotModal", () => ({
			visible: false,
			loading: false,
			form: {
				name: "",
				identifier: "",
				platform: "WHATSAPP",
			} as CreateBotForm,

			open() {
				this.visible = true;
				this.form = { name: "", identifier: "", platform: "WHATSAPP" };
			},

			close() {
				this.visible = false;
			},

			async submit() {
				if (!this.form.name || !this.form.identifier) return;

				this.loading = true;
				try {
					await ApiClient.post("/bots", this.form);
					window.location.reload(); // Reload to re-trigger CSR fetch
				} catch (e: unknown) {
					const error = e as Error;
					alert(error.message || "Failed to create bot");
				} finally {
					this.loading = false;
				}
			},
		}));
	});
</script>
