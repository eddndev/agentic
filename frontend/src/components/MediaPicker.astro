<div
    x-data="mediaPicker"
    x-show="open"
    @keydown.escape.window="close()"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/80"
    style="display: none;"
>
    <div
        class="bg-wa-bg-panel border border-wa-border rounded-xl w-full max-w-2xl h-[80vh] md:h-[600px] mx-4 flex flex-col shadow-2xl relative"
    >
        <!-- Header -->
        <div
            class="px-6 py-4 border-b border-wa-border flex justify-between items-center bg-wa-bg-header rounded-t-xl"
        >
            <h3
                class="text-sm font-bold text-wa-green"
            >
                Select Media
            </h3>
            <button @click="close()" class="text-wa-text-secondary hover:text-white"
                >&times;</button
            >
        </div>

        <!-- Tabs -->
        <div
            class="flex border-b border-wa-border text-sm"
        >
            <button
                @click="tab = 'upload'"
                :class="tab === 'upload' ? 'bg-wa-green/10 text-wa-green border-b-2 border-wa-green' : 'text-wa-text-secondary hover:bg-wa-bg-hover'"
                class="flex-1 py-3 text-center transition-colors"
            >
                Upload New
            </button>
            <button
                @click="fetchFiles(); tab = 'gallery'"
                :class="tab === 'gallery' ? 'bg-wa-green/10 text-wa-green border-b-2 border-wa-green' : 'text-wa-text-secondary hover:bg-wa-bg-hover'"
                class="flex-1 py-3 text-center transition-colors"
            >
                Gallery
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- UPLOAD TAB -->
            <div
                x-show="tab === 'upload'"
                class="h-full flex flex-col justify-center"
            >
                <div
                    @dragover.prevent="dragover = true"
                    @dragleave.prevent="dragover = false"
                    @drop.prevent="handleDrop($event)"
                    :class="dragover ? 'border-wa-green bg-wa-green/10' : 'border-wa-border hover:border-wa-text-secondary'"
                    class="border-2 border-dashed rounded-xl p-6 md:p-12 text-center transition-all cursor-pointer relative"
                >
                    <input
                        type="file"
                        @change="handleFileSelect($event)"
                        class="absolute inset-0 opacity-0 cursor-pointer"
                    />

                    <div x-show="!uploading">
                        <svg
                            class="w-12 h-12 mx-auto text-wa-text-secondary mb-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                            ></path>
                        </svg>
                        <p class="text-sm text-wa-text-primary">
                            Drag & Drop or Click to Upload
                        </p>
                    </div>

                    <div x-show="uploading" class="text-wa-green">
                        <svg
                            class="animate-spin w-8 h-8 mx-auto mb-2"
                            viewBox="0 0 24 24"
                            ><circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"></circle><path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                            ></path></svg
                        >
                        <p class="text-xs">Uploading...</p>
                    </div>
                </div>
            </div>

            <!-- GALLERY TAB -->
            <div x-show="tab === 'gallery'">
                <div x-show="loading" class="text-center py-12">
                    <span
                        class="text-wa-green animate-pulse text-xs"
                        >Loading Files...</span
                    >
                </div>

                <div
                    x-show="!loading && files.length === 0"
                    class="text-center py-12 text-wa-text-secondary text-xs"
                >
                    No files found. Upload one first.
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <template x-for="file in files" :key="file.name">
                        <div
                            @click="select(file.url)"
                            class="group relative aspect-square border border-wa-border rounded-lg bg-wa-bg-deep hover:border-wa-green cursor-pointer transition-colors overflow-hidden"
                        >
                            <!-- Preview (Image) -->
                            <template x-if="isImage(file.name)">
                                <img
                                    :src="getApiUrl(file.url)"
                                    class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity"
                                />
                            </template>

                            <!-- Preview (Generic) -->
                            <template x-if="!isImage(file.name)">
                                <div
                                    class="w-full h-full flex items-center justify-center text-wa-text-secondary group-hover:text-white"
                                >
                                    <span
                                        class="text-xs font-mono break-all px-2"
                                        x-text="file.name"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    import { ApiClient } from "../lib/api";

    // @ts-ignore
    declare const Alpine: any;

    document.addEventListener("alpine:init", () => {
        Alpine.data("mediaPicker", () => ({
            open: false,
            tab: "upload",
            dragover: false,
            uploading: false,
            loading: false,
            files: [] as any[],
            callback: null as any,

            init() {
                // Listen to global event to open picker
                window.addEventListener("open-media-picker", (e: any) => {
                    this.open = true;
                    this.callback = e.detail?.callback;
                    this.tab = "upload";
                    this.fetchFiles();
                });
            },

            close() {
                this.open = false;
                this.callback = null;
            },

            getApiUrl(path: string) {
                const base =
                    import.meta.env.PUBLIC_API_URL ||
                    (import.meta.env.DEV
                        ? "http://localhost:8080"
                        : "https://api-agentic.angelviajero.com.mx");
                return `${base}${path.startsWith("/") ? "" : "/"}${path}`;
            },

            isImage(filename: string) {
                return /\.(jpg|jpeg|png|gif|webp)$/i.test(filename);
            },

            async fetchFiles() {
                this.loading = true;
                try {
                    const res = await ApiClient.get("/upload/list");
                    this.files = res.files || [];
                } catch (e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                }
            },

            async handleFileSelect(e: any) {
                const file = e.target.files[0];
                if (file) await this.upload(file);
            },

            async handleDrop(e: any) {
                this.dragover = false;
                const file = e.dataTransfer.files[0];
                if (file) await this.upload(file);
            },

            async upload(file: File) {
                this.uploading = true;
                const formData = new FormData();
                formData.append("file", file);

                try {
                    const base =
                        import.meta.env.PUBLIC_API_URL ||
                        (import.meta.env.DEV
                            ? "http://localhost:8080"
                            : "https://api-agentic.angelviajero.com.mx");
                    const res = await fetch(`${base}/upload`, {
                        method: "POST",
                        body: formData,
                    }).then((r) => r.json());

                    if (res.status === "success") {
                        this.select(res.url);
                    }
                } catch (e) {
                    alert("Upload failed");
                } finally {
                    this.uploading = false;
                }
            },

            select(url: string) {
                const fullUrl = this.getApiUrl(url);
                if (this.callback) this.callback(fullUrl);
                this.close();
            },
        }));
    });
</script>
