---
interface Props {
    botId: string;
}

const { botId } = Astro.props;
---

<div
    x-data={`botConnection('${botId}')`}
    class="connection-panel p-4 bg-wa-bg-panel border border-wa-border rounded-xl"
>
    <script>
        import { ApiClient } from "../lib/api";
        import { BotEventSource } from "../lib/events";
        // @ts-ignore
        declare const Alpine: any;

        document.addEventListener("alpine:init", () => {
            Alpine.data("botConnection", (botId: string) => ({
                botId,
                status: "DISCONNECTED",
                qr: null,
                loading: false,
                sseClient: null as BotEventSource | null,

                async init() {
                    this.checkStatus();

                    // SSE for real-time QR/status updates
                    this.sseClient = new BotEventSource(this.botId);
                    this.sseClient
                        .on('bot:qr', (data: any) => {
                            this.status = 'SCAN_QR';
                            this.qr = data.qr;
                        })
                        .on('bot:connected', () => {
                            this.status = 'CONNECTED';
                            this.qr = null;
                        })
                        .on('bot:disconnected', () => {
                            this.status = 'DISCONNECTED';
                            this.qr = null;
                        });
                    this.sseClient.connect();
                },

                destroy() {
                    if (this.sseClient) this.sseClient.close();
                },

                async checkStatus() {
                    try {
                        const res = await ApiClient.get(
                            `/bots/${this.botId}/status`,
                        );

                        if (res.connected) {
                            this.status = "CONNECTED";
                            this.qr = null;
                        } else if (res.hasQr) {
                            this.status = "SCAN_QR";
                            const qrRes = await ApiClient.get(
                                `/bots/${this.botId}/qr`,
                            );
                            this.qr = qrRes.qr;
                        } else {
                            this.status = "DISCONNECTED";
                            this.qr = null;
                        }
                    } catch (e) {
                        console.error("Status check failed", e);
                    }
                },

                async connect() {
                    this.loading = true;
                    try {
                        await ApiClient.post(`/bots/${this.botId}/connect`, {});
                        await this.checkStatus();
                    } catch (e) {
                        // @ts-ignore
                        alert(this.$t("error"));
                    } finally {
                        this.loading = false;
                    }
                },

                async disconnect() {
                    // @ts-ignore
                    if (!confirm(this.$t("disconnect") + "?")) return;
                },

                getStatusLabel() {
                    if (this.status === "CONNECTED") return this.$t("active");
                    if (this.status === "SCAN_QR") return this.$t("scan_qr");
                    return this.$t("disconnected");
                },
            }));
        });
    </script>

    <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
        <h3
            class="text-sm font-bold text-wa-text-secondary"
            x-text="$t('whatsapp_baileys')"
        >
        </h3>

        <div class="flex items-center gap-2">
            <span
                class="px-2 py-0.5 text-[10px] border rounded-md whitespace-nowrap"
                :class="{
                'border-green-500/50 text-green-400 bg-green-500/10': status === 'CONNECTED',
                'border-yellow-500/50 text-yellow-400 bg-yellow-500/10': status === 'SCAN_QR',
                'border-red-500/50 text-red-400 bg-red-500/10': status === 'DISCONNECTED'
              }"
                x-text="getStatusLabel()"></span>
        </div>
    </div>

    <!-- QR View -->
    <template x-if="status === 'SCAN_QR' && qr">
        <div class="text-center py-4">
            <img
                :src="qr"
                class="w-full max-w-[12rem] aspect-square mx-auto border-4 border-white rounded-xl shadow-2xl"
            />
            <p
                class="mt-4 text-xs text-wa-text-secondary animate-pulse"
                x-text="$t('scan_whatsapp')"
            >
            </p>
        </div>
    </template>

    <!-- Connect Button -->
    <template x-if="status === 'DISCONNECTED'">
        <button
            @click="connect()"
            :disabled="loading"
            class="w-full py-2 px-4 bg-wa-green hover:bg-wa-green-hover text-white text-sm rounded-lg transition-colors disabled:opacity-50"
        >
            <span x-show="!loading" x-text="$t('start_connection')"></span>
            <span x-show="loading" x-text="$t('initializing')"></span>
        </button>
    </template>

    <!-- Connected View -->
    <template x-if="status === 'CONNECTED'">
        <div class="text-center py-8">
            <div
                class="w-16 h-16 bg-green-500/20 text-green-400 rounded-xl flex items-center justify-center mx-auto mb-2 border border-green-500/50"
            >
                <svg
                    class="w-8 h-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"></path></svg
                >
            </div>
            <p
                class="text-xs text-green-400"
            >
                System Online
            </p>
        </div>
    </template>
</div>
