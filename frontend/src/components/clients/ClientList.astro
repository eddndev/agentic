---
---

<div
    x-data={`{
    clients: [],
    loading: true,
    detailClient: null,
    editData: {},
    saving: false,

    get botId() {
        return new URLSearchParams(window.location.search).get('id') || '';
    },

    async fetchClients() {
        if (!this.botId) return;
        this.loading = true;
        try {
            const data = await ApiClient.get('/clients?botId=' + this.botId);
            this.clients = data;
        } catch (e) {
            console.error(e);
        } finally {
            this.loading = false;
        }
    },

    init() {
        this.fetchClients();
    },

    openDetail(client) {
        this.detailClient = client;
        this.editData = {
            email: client.email,
            phoneNumber: client.phoneNumber,
            curp: client.curp || '',
            status: client.status,
        };
    },

    closeDetail() {
        this.detailClient = null;
    },

    async saveEdit() {
        if (!this.detailClient) return;
        this.saving = true;
        try {
            await ApiClient.put('/clients/' + this.detailClient.id, this.editData);
            await this.fetchClients();
            this.closeDetail();
        } catch (e) {
            console.error(e);
            alert('Error: ' + e.message);
        } finally {
            this.saving = false;
        }
    },

    async deleteClient(client) {
        if (!confirm('Eliminar cliente ' + client.email + '?')) return;
        try {
            await ApiClient.delete('/clients/' + client.id);
            await this.fetchClients();
        } catch (e) {
            console.error(e);
            alert('Error: ' + e.message);
        }
    },

    statusColor(status) {
        const map = {
            'REGISTRO_PENDIENTE': 'bg-yellow-500/20 text-yellow-500',
            'PAGO_GOBIERNO_PENDIENTE': 'bg-orange-500/20 text-orange-400',
            'PAGO_GOBIERNO_REALIZADO': 'bg-blue-500/20 text-blue-400',
            'EXAMEN_EN_PROCESO': 'bg-purple-500/20 text-purple-400',
            'LICENCIA_LISTA': 'bg-cyan-500/20 text-cyan-400',
            'COMPLETADO': 'bg-green-500/20 text-green-400',
        };
        return map[status] || 'bg-gray-500/20 text-gray-400';
    }
}`}
>
    <!-- Empty State -->
    <template x-if="!loading && clients.length === 0">
        <div class="text-center py-10 text-wa-text-secondary">
            <p>No hay clientes registrados en este bot.</p>
        </div>
    </template>

    <!-- Loading -->
    <template x-if="loading">
        <div class="text-center py-10">
            <span class="text-xs text-wa-text-secondary animate-pulse">Cargando...</span>
        </div>
    </template>

    <!-- Table -->
    <div class="overflow-x-auto" x-show="!loading && clients.length > 0">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="text-xs text-wa-text-secondary border-b border-wa-border">
                    <th class="p-3">CURP</th>
                    <th class="p-3">Status</th>
                    <th class="p-3">Email</th>
                    <th class="p-3">Telefono</th>
                    <th class="p-3">Registro</th>
                    <th class="p-3 text-right">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-wa-border">
                <template x-for="client in clients" :key="client.id">
                    <tr class="hover:bg-wa-bg-hover transition-colors">
                        <td class="p-3 text-wa-text-secondary font-mono text-xs" x-text="client.curp || '-'"></td>
                        <td class="p-3">
                            <span
                                class="px-2 py-1 rounded-md text-[10px] font-bold"
                                :class="statusColor(client.status)"
                                x-text="client.status ? client.status.replace(/_/g, ' ') : 'PENDIENTE'"
                            ></span>
                        </td>
                        <td class="p-3 text-wa-text-secondary" x-text="client.email"></td>
                        <td class="p-3 text-wa-text-secondary" x-text="client.phoneNumber"></td>
                        <td class="p-3 text-wa-text-secondary text-xs" x-text="new Date(client.createdAt).toLocaleDateString()"></td>
                        <td class="p-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button
                                    @click="openDetail(client)"
                                    class="px-3 py-1 text-[10px] border border-wa-border text-wa-text-secondary hover:text-white hover:bg-wa-bg-hover transition-colors rounded-lg"
                                >
                                    Detalle
                                </button>
                                <button
                                    @click="deleteClient(client)"
                                    class="px-3 py-1 text-[10px] border border-red-500/30 text-red-500 hover:bg-red-500/10 transition-colors rounded-lg"
                                >
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Detail/Edit Modal -->
    <div
        x-show="detailClient"
        x-transition.opacity
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        style="display: none;"
    >
        <div class="absolute inset-0 bg-black/80" @click="closeDetail()"></div>

        <div class="relative bg-wa-bg-panel border border-wa-border rounded-xl p-8 w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl">
            <h2 class="text-xl font-bold tracking-tight mb-6 flex justify-between items-center">
                <span>Detalle de Cliente</span>
                <button @click="closeDetail()" class="text-wa-text-secondary hover:text-white">&times;</button>
            </h2>

            <template x-if="detailClient">
                <div class="space-y-5">
                    <!-- Read-only info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="block text-[10px] text-wa-text-secondary mb-1">ID</span>
                            <span class="text-wa-text-secondary font-mono text-[11px] select-all" x-text="detailClient.id"></span>
                        </div>
                        <div>
                            <span class="block text-[10px] text-wa-text-secondary mb-1">Telefono</span>
                            <span class="text-white font-mono text-sm" x-text="detailClient.phoneNumber"></span>
                        </div>
                        <div>
                            <span class="block text-[10px] text-wa-text-secondary mb-1">Registrado</span>
                            <span class="text-white text-sm" x-text="new Date(detailClient.createdAt).toLocaleString()"></span>
                        </div>
                        <div>
                            <span class="block text-[10px] text-wa-text-secondary mb-1">Actualizado</span>
                            <span class="text-white text-sm" x-text="new Date(detailClient.updatedAt).toLocaleString()"></span>
                        </div>
                    </div>

                    <hr class="border-wa-border" />

                    <!-- Editable fields -->
                    <div>
                        <label class="block text-xs text-wa-text-secondary mb-2">Email</label>
                        <input type="email" x-model="editData.email"
                            class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white placeholder-wa-text-secondary" />
                    </div>

                    <div>
                        <label class="block text-xs text-wa-text-secondary mb-2">Telefono</label>
                        <input type="text" x-model="editData.phoneNumber"
                            class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white placeholder-wa-text-secondary font-mono" />
                    </div>

                    <div>
                        <label class="block text-xs text-wa-text-secondary mb-2">CURP</label>
                        <input type="text" x-model="editData.curp" maxlength="18"
                            class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white placeholder-wa-text-secondary font-mono uppercase"
                            placeholder="CURP (18 caracteres)" />
                    </div>

                    <div>
                        <label class="block text-xs text-wa-text-secondary mb-2">Estatus</label>
                        <select x-model="editData.status"
                            class="w-full bg-wa-bg-hover border border-wa-border rounded-lg p-3 text-sm focus:border-wa-green focus:outline-none text-white">
                            <option value="REGISTRO_PENDIENTE">Registro Pendiente</option>
                            <option value="PAGO_GOBIERNO_PENDIENTE">Pago Gobierno Pendiente</option>
                            <option value="PAGO_GOBIERNO_REALIZADO">Pago Gobierno Realizado</option>
                            <option value="EXAMEN_EN_PROCESO">Examen en Proceso</option>
                            <option value="LICENCIA_LISTA">Licencia Lista</option>
                            <option value="COMPLETADO">Completado</option>
                        </select>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-6 mt-2 border-t border-wa-border">
                        <button type="button" @click="closeDetail()"
                            class="flex-1 px-4 py-3 border border-wa-border text-wa-text-secondary text-sm rounded-lg hover:bg-wa-bg-hover transition-colors">
                            Cancelar
                        </button>
                        <button type="button" @click="saveEdit()" :disabled="saving"
                            class="flex-1 px-4 py-3 bg-wa-green text-white text-sm rounded-lg hover:bg-wa-green-hover disabled:opacity-50 transition-colors"
                            x-text="saving ? 'Guardando...' : 'Guardar Cambios'">
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    import { ApiClient } from "../../lib/api";
    window.ApiClient = ApiClient;
</script>
